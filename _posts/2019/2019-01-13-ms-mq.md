---
layout:     post
title:    轻松构建微服务之消息队列
no-post-nav: true
category: other
tags: [arch]
excerpt: 消息队列
---

## 前言

RocketMQ
消息队列的三大好处：应用解耦，流量削峰，消息分发

消息拉取的三种模式：循环拉，实时推送，长轮询拉结合推送有消息让后客户端去批量拉

实时推回加大broker的负担，影响性能，其次client的处理能力不相同，如果client不能及时处理消息可能会有潜在问题
pull循环的间隔时间不好控制，设置的太久影响失效，设置太短可能每次都没有新消息浪费资源
长轮询方式客户端请求后，服务端等到有消息后在返回。客户端拉取的时候可以设置一个broker最长阻塞时间，一般为15秒，长轮询方式的弊端会试需要占有broker资源，这种只适合在客户端连接数可控的情况下

流控情况：客户端可以根据自己的负载进行控制，客户端pull到消息后悔放到线程池里处理，很难监控和控制，例如怎么知道当前消息堆积的数量，哪些消息处理失败，rocketmq用一个processqueue来维护从broker获取到但是还没有处理的消息，用读写锁控制多个线程对ProcessQueue的访问，然后通过ProcessQueue做流控，就是每次去broker拉取消息的时候都会在ProcessQueue里判断当前未处理消息的数量





一个topic可以设置多个queue,这样生产者就可以并行的向多个队列发送消息，消费者也可以同时从不同的queue获取消息，